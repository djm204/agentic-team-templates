---
description: Kotlin Testing
alwaysApply: false
---

# Kotlin Testing

Test behavior with expressive assertions. Coroutines require special test infrastructure. Tools: JUnit 5/Kotest, MockK, kotlinx-coroutines-test, Testcontainers.

## Unit Tests

```kotlin
@Test
fun `create with valid items returns success`() = runTest {
  coEvery { inventoryClient.checkAvailability("SKU-001", 2) } returns true
  coEvery { orderRepo.save(any()) } answers { firstArg() }
  val result = sut.create(CreateOrderRequest("customer-1", listOf(OrderItemRequest("SKU-001", 2))))
  assertThat(result).isInstanceOf(Result.Success::class.java)
  assertThat((result as Result.Success).value.customerId).isEqualTo("customer-1")
}
```

## Coroutine Testing

```kotlin
@Test
fun `polling retries on failure`() = runTest {
  var attempts = 0
  coEvery { service.fetch() } answers {
    if (++attempts < 3) throw IOException("Temporary") else Data("success")
  }
  val result = sut.fetchWithRetry(maxRetries = 3)
  assertThat(result.value).isEqualTo("success")
}

@Test
fun `cache expires after TTL`() = runTest {
  cache.set("key", "value")
  assertThat(cache.get("key")).isEqualTo("value")
  advanceTimeBy(cacheTtl + 1.seconds)
  assertThat(cache.get("key")).isNull()
}
```

## MockK

```kotlin
coEvery { userRepo.findById(any()) } returns User(id = "1", name = "Alice")
coVerify(exactly = 1) { emailService.send("alice@test.com", any(), any()) }
val slot = slot<User>()
coEvery { userRepo.save(capture(slot)) } answers { firstArg() }
sut.create(request)
assertThat(slot.captured.name).isEqualTo("Alice")
```

## Data-Driven Tests (Kotest)

```kotlin
class SlugifyTest : FunSpec({
  withData("Hello World" to "hello-world", "  spaces  " to "spaces", "" to "") { (input, expected) ->
    slugify(input) shouldBe expected
  }
})
```

## Anti-Patterns

- Never `Thread.sleep` in tests — use `runTest` + `advanceTimeBy`
- Never test internal implementation — test observable outcomes
- Never share mutable state between tests — reset in `@BeforeEach`
